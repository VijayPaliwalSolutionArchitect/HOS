// ===========================================
// Multi-Tenant EdTech SaaS Platform Schema
// ===========================================
// Database: PostgreSQL
// ORM: Prisma
// ===========================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// ENUMS
// ===========================================

enum Role {
  STUDENT
  TEACHER
  MANAGER
  ADMIN
  SUPER_ADMIN
}

enum Theme {
  LIGHT
  DARK
  SYSTEM
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
  EXPERT
}

enum QuestionType {
  MCQ_SINGLE
  MCQ_MULTI
  TRUE_FALSE
  FILL_BLANK
  CASE_BASED
}

enum AttemptStatus {
  IN_PROGRESS
  PAUSED
  COMPLETED
  ABANDONED
  FLAGGED
}

enum AssignmentTarget {
  USER
  GROUP
  CLASS
  ALL
}

enum NotificationType {
  EXAM_ASSIGNED
  EXAM_REMINDER
  RESULT_PUBLISHED
  ACHIEVEMENT_UNLOCKED
  SYSTEM
}

enum SubscriptionPlan {
  FREE
  PRO
  INSTITUTION
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
}

enum BadgeRarity {
  COMMON
  RARE
  EPIC
  LEGENDARY
}

enum AchievementCategory {
  PRACTICE
  STREAK
  SCORE
  SOCIAL
  MILESTONE
}

// ===========================================
// CORE MODELS
// ===========================================

// Tenant (Organization) Model
model Tenant {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  domain      String?   @unique
  logo        String?
  isActive    Boolean   @default(true)
  settings    Json?     // Tenant-specific settings
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  
  // Relations
  users         User[]
  categories    Category[]
  courses       Course[]
  questions     Question[]
  exams         Exam[]
  subscriptions Subscription[]
  auditLogs     AuditLog[]
  
  @@index([isActive])
  @@index([slug])
}

// User Model with Multi-Tenant Support
model User {
  id              String    @id @default(uuid())
  tenantId        String
  email           String
  emailVerified   DateTime?
  name            String?
  image           String?
  password        String?
  role            Role      @default(STUDENT)
  isActive        Boolean   @default(true)
  
  // Profile
  bio             String?
  phone           String?
  country         String?
  timezone        String?   @default("UTC")
  
  // Gamification
  xpPoints        Int       @default(0)
  level           Int       @default(1)
  streak          Int       @default(0)
  longestStreak   Int       @default(0)
  lastActiveAt    DateTime  @default(now())
  
  // Preferences
  theme           Theme     @default(SYSTEM)
  notifications   Boolean   @default(true)
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?
  
  // Relations
  tenant              Tenant              @relation(fields: [tenantId], references: [id])
  accounts            Account[]
  sessions            Session[]
  createdCourses      Course[]            @relation("CourseCreator")
  createdQuestions    Question[]          @relation("QuestionCreator")
  createdExams        Exam[]              @relation("ExamCreator")
  examAttempts        ExamAttempt[]
  badges              UserBadge[]
  achievements        UserAchievement[]
  userNotifications   Notification[]
  
  @@unique([tenantId, email])
  @@index([tenantId, role])
  @@index([tenantId, isActive])
}

// OAuth Account model
model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([provider, providerAccountId])
  @@index([userId])
}

// Session model
model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

// Verification token
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  
  @@unique([identifier, token])
}

// ===========================================
// CATEGORY & COURSE MODELS
// ===========================================

// Category Model (Hierarchical)
model Category {
  id          String    @id @default(uuid())
  tenantId    String
  name        String
  slug        String
  description String?
  icon        String?
  color       String?
  parentId    String?
  order       Int       @default(0)
  isActive    Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  
  // Relations
  tenant      Tenant     @relation(fields: [tenantId], references: [id])
  parent      Category?  @relation("CategoryTree", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryTree")
  courses     Course[]
  questions   Question[]
  
  @@unique([tenantId, slug])
  @@index([tenantId, parentId])
  @@index([tenantId, isActive])
}

// Course Model
model Course {
  id              String     @id @default(uuid())
  tenantId        String
  categoryId      String?
  title           String
  slug            String
  description     String?
  thumbnail       String?
  duration        Int?       // in minutes
  difficulty      Difficulty @default(MEDIUM)
  isPublished     Boolean    @default(false)
  isFeatured      Boolean    @default(false)
  price           Float?     @default(0)
  
  // Content
  content         Json?      // Rich content structure
  objectives      String[]   @default([])
  prerequisites   String[]   @default([])
  tags            String[]   @default([])
  
  // Analytics
  enrollmentCount Int        @default(0)
  avgRating       Float?
  
  // Timestamps
  publishedAt     DateTime?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  deletedAt       DateTime?
  
  // Relations
  tenant          Tenant         @relation(fields: [tenantId], references: [id])
  category        Category?      @relation(fields: [categoryId], references: [id])
  createdById     String
  createdBy       User           @relation("CourseCreator", fields: [createdById], references: [id])
  modules         CourseModule[]
  exams           Exam[]
  
  @@unique([tenantId, slug])
  @@index([tenantId, isPublished])
  @@index([tenantId, categoryId])
}

model CourseModule {
  id          String   @id @default(uuid())
  courseId    String
  title       String
  description String?
  order       Int      @default(0)
  duration    Int?     // in minutes
  content     Json?    // Rich content (notes, videos, PDFs, links)
  isPublished Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@index([courseId, order])
}

// ===========================================
// QUESTION BANK MODELS
// ===========================================

// Question Bank Model
model Question {
  id            String       @id @default(uuid())
  tenantId      String
  categoryId    String?
  type          QuestionType @default(MCQ_SINGLE)
  text          String       // Question text (supports markdown)
  difficulty    Int          @default(3) // 1-5 scale
  marks         Float        @default(1)
  negativeMarks Float        @default(0)
  timeLimit     Int?         // seconds
  
  // Options stored as JSON
  options       Json         // [{id, text, isCorrect}]
  correctAnswer Json         // For validation
  explanation   String?
  
  // Media
  imageUrl      String?
  audioUrl      String?
  videoUrl      String?
  
  // Metadata
  tags          String[]     @default([])
  isApproved    Boolean      @default(false)
  isAIGenerated Boolean      @default(false)
  aiConfidence  Float?
  
  // Analytics
  attemptCount  Int          @default(0)
  correctRate   Float?
  avgTimeSpent  Float?
  
  // Timestamps
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  deletedAt     DateTime?
  
  // Relations
  tenant        Tenant         @relation(fields: [tenantId], references: [id])
  category      Category?      @relation(fields: [categoryId], references: [id])
  createdById   String
  createdBy     User           @relation("QuestionCreator", fields: [createdById], references: [id])
  examQuestions ExamQuestion[]
  
  @@index([tenantId, categoryId])
  @@index([tenantId, difficulty])
  @@index([tenantId, isApproved])
}

// ===========================================
// EXAM MODELS
// ===========================================

// Exam Model (Versioned)
model Exam {
  id            String    @id @default(uuid())
  tenantId      String
  courseId      String?
  title         String
  slug          String
  description   String?
  version       Int       @default(1)
  isLatest      Boolean   @default(true)
  
  // Configuration
  duration      Int       // minutes
  totalMarks    Float
  passingMarks  Float
  totalQuestions Int
  
  // Rules
  rules         Json?     // {shuffleQuestions, shuffleOptions, showResults, allowReview, etc.}
  
  // Scheduling
  isPublished   Boolean   @default(false)
  startTime     DateTime?
  endTime       DateTime?
  
  // Analytics
  attemptCount  Int       @default(0)
  avgScore      Float?
  
  // Timestamps
  publishedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?
  
  // Relations
  tenant        Tenant           @relation(fields: [tenantId], references: [id])
  course        Course?          @relation(fields: [courseId], references: [id])
  createdById   String
  createdBy     User             @relation("ExamCreator", fields: [createdById], references: [id])
  questions     ExamQuestion[]
  attempts      ExamAttempt[]
  assignments   ExamAssignment[]
  
  @@unique([tenantId, slug, version])
  @@index([tenantId, isPublished])
  @@index([tenantId, courseId])
}

model ExamQuestion {
  id          String   @id @default(uuid())
  examId      String
  questionId  String
  order       Int      @default(0)
  marks       Float?   // Override question marks if needed
  
  // Snapshot of question at exam creation time
  snapshot    Json?
  
  // Relations
  exam        Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  question    Question @relation(fields: [questionId], references: [id])
  
  @@unique([examId, questionId])
  @@index([examId, order])
}

model ExamAssignment {
  id          String           @id @default(uuid())
  tenantId    String
  examId      String
  targetType  AssignmentTarget
  targetId    String           // userId, groupId, or classId
  
  startTime   DateTime?
  endTime     DateTime?
  maxAttempts Int              @default(1)
  
  createdAt   DateTime         @default(now())
  
  // Relations
  exam        Exam             @relation(fields: [examId], references: [id])
  
  @@index([tenantId, examId])
  @@index([targetType, targetId])
}

// Exam Attempt Model (Immutable)
model ExamAttempt {
  id              String        @id @default(uuid())
  tenantId        String
  examId          String
  userId          String
  
  // Timing
  startedAt       DateTime      @default(now())
  completedAt     DateTime?
  timeTaken       Int?          // seconds
  
  // Scoring
  score           Float?
  percentage      Float?
  totalMarks      Float?
  obtainedMarks   Float?
  correctCount    Int           @default(0)
  incorrectCount  Int           @default(0)
  skippedCount    Int           @default(0)
  
  // Status
  status          AttemptStatus @default(IN_PROGRESS)
  
  // Answers stored as JSON
  answers         Json?         // [{questionId, selectedOption, isCorrect, timeSpent}]
  
  // Anti-cheating
  riskScore       Int?
  riskFlags       String[]      @default([])
  telemetryData   Json?
  
  // Device info
  deviceType      String?
  browserInfo     String?
  ipAddress       String?
  
  // Result
  result          ExamResult?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  exam            Exam          @relation(fields: [examId], references: [id])
  user            User          @relation(fields: [userId], references: [id])
  
  @@unique([examId, userId, startedAt])
  @@index([tenantId, userId])
  @@index([tenantId, examId])
  @@index([status])
}

model ExamResult {
  id            String      @id @default(uuid())
  attemptId     String      @unique
  
  // PDF
  pdfUrl        String?
  pdfGeneratedAt DateTime?
  
  // Sharing
  shareToken    String      @unique @default(uuid())
  shareCount    Int         @default(0)
  
  // AI Insights
  aiInsights    Json?
  
  // Email
  sentToEmail   String?
  sentAt        DateTime?
  
  createdAt     DateTime    @default(now())
  
  // Relations
  attempt       ExamAttempt @relation(fields: [attemptId], references: [id])
  
  @@index([shareToken])
}

// ===========================================
// AUDIT & TELEMETRY MODELS
// ===========================================

// Audit Log Model
model AuditLog {
  id          String   @id @default(uuid())
  tenantId    String
  userId      String?
  action      String   // CREATE, UPDATE, DELETE, LOGIN, etc.
  entity      String   // User, Question, Exam, etc.
  entityId    String?
  oldValue    Json?
  newValue    Json?
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime @default(now())
  
  // Relations
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  @@index([tenantId, entity])
  @@index([tenantId, userId])
  @@index([createdAt])
}

// Telemetry for Anti-Cheating
model ExamTelemetry {
  id          String   @id @default(uuid())
  attemptId   String
  event       String   // TAB_SWITCH, BLUR, PASTE, RIGHT_CLICK, etc.
  payload     Json?
  timestamp   DateTime @default(now())
  
  @@index([attemptId])
  @@index([event])
}

// ===========================================
// NOTIFICATION MODEL
// ===========================================

// Notification Model
model Notification {
  id          String           @id @default(uuid())
  tenantId    String
  userId      String
  type        NotificationType
  title       String
  message     String
  data        Json?
  isRead      Boolean          @default(false)
  readAt      DateTime?
  
  createdAt   DateTime         @default(now())
  
  // Relations
  user        User             @relation(fields: [userId], references: [id])
  
  @@index([tenantId, userId, isRead])
}

// ===========================================
// SUBSCRIPTION/BILLING MODELS
// ===========================================

// Subscription/Billing Model
model Subscription {
  id            String             @id @default(uuid())
  tenantId      String
  plan          SubscriptionPlan   @default(FREE)
  status        SubscriptionStatus @default(ACTIVE)
  
  // Stripe integration
  stripeCustomerId     String?
  stripeSubscriptionId String?
  
  // Limits
  maxUsers      Int       @default(10)
  maxQuestions  Int       @default(100)
  maxExams      Int       @default(10)
  aiCredits     Int       @default(0)
  storageLimit  Int       @default(1000) // MB
  
  // Billing
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  tenant        Tenant    @relation(fields: [tenantId], references: [id])
  
  @@index([tenantId])
  @@index([status])
}

// ===========================================
// GAMIFICATION MODELS
// ===========================================

// Badge & Achievement Models (Gamification)
model Badge {
  id          String      @id @default(uuid())
  name        String      @unique
  description String
  icon        String
  rarity      BadgeRarity @default(COMMON)
  xpReward    Int         @default(50)
  criteria    Json?
  
  createdAt   DateTime    @default(now())
  
  users       UserBadge[]
}

model UserBadge {
  id        String   @id @default(uuid())
  userId    String
  badgeId   String
  earnedAt  DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  
  @@unique([userId, badgeId])
  @@index([userId])
}

model Achievement {
  id          String              @id @default(uuid())
  name        String              @unique
  description String
  icon        String
  category    AchievementCategory @default(PRACTICE)
  xpReward    Int                 @default(100)
  targetValue Int                 @default(1)
  criteria    Json?
  
  createdAt   DateTime            @default(now())
  
  users       UserAchievement[]
}

model UserAchievement {
  id            String      @id @default(uuid())
  userId        String
  achievementId String
  progress      Int         @default(0)
  isCompleted   Boolean     @default(false)
  completedAt   DateTime?
  
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  
  @@unique([userId, achievementId])
  @@index([userId])
}

// ===========================================
// PROMOTION MODEL
// ===========================================

// Promotion/Popup Model (Admin controlled)
model Promotion {
  id          String    @id @default(uuid())
  tenantId    String?   // null = global
  title       String
  content     String    // HTML/Markdown
  imageUrl    String?
  linkUrl     String?
  targetRoles Role[]    @default([])
  
  isActive    Boolean   @default(true)
  startDate   DateTime?
  endDate     DateTime?
  
  // Analytics
  viewCount   Int       @default(0)
  clickCount  Int       @default(0)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([isActive])
}

// ===========================================
// AI GENERATION LOG
// ===========================================

// AI Generation Log
model AIGenerationLog {
  id          String   @id @default(uuid())
  tenantId    String
  userId      String
  type        String   // QUESTION, COURSE, QUIZ
  prompt      String
  response    Json?
  tokens      Int?
  cost        Float?
  status      String   // SUCCESS, FAILED, PENDING
  
  createdAt   DateTime @default(now())
  
  @@index([tenantId, type])
  @@index([tenantId, userId])
}
